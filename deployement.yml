apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  # Database Configuration
  POSTGRES_USER: "postgres"
  POSTGRES_PASSWORD: "password"
  POSTGRES_DB: "mediassist"
  POSTGRES_Server: "postgres-svc"
  POSTGRES_PORT: "5432"
  DATABASE_URL: "postgresql://postgres:password@postgres-svc:5432/mediassist"
  
  # External Services
  QDRANT_URL: "http://qdrant-svc:6333"
  OLLAMA_BASE_URL: "http://ollama-svc:11434"
  MLFLOW_TRACKING_URI: "http://mlflow-svc:5000"
  
  # Application Settings
  ENVIRONMENT: "production"
  SECRET_KEY: "your-secret-key-here-change-in-production"
  ALGORITHM: "HS256"

---

# Backend Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: project-deployement
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
        - name: backend
          image: bouchras/mediassist-backend:latest
          ports:
            - containerPort: 8000
          envFrom:
            - configMapRef:
                name: app-config

---

# Postgres Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-deployement
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:15-alpine
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_USER
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_DB
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: POSTGRES_DB
          volumeMounts:
            - name: postgres-storage
              mountPath: /var/lib/postgresql/data
      volumes:
        - name: postgres-storage
          emptyDir: {}

---

# Qdrant Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: qdrant-deployement
spec:
  replicas: 1
  selector:
    matchLabels:
      app: qdrant
  template:
    metadata:
      labels:
        app: qdrant
    spec:
      containers:
        - name: qdrant
          image: qdrant/qdrant:latest
          ports:
            - containerPort: 6333
          volumeMounts:
            - name: qdrant-storage
              mountPath: /qdrant/storage
      volumes:
        - name: qdrant-storage
          emptyDir: {}

---

# Ollama Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ollama-deployement
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ollama
  template:
    metadata:
      labels:
        app: ollama
    spec:
      containers:
        - name: ollama
          image: ollama/ollama:latest
          ports:
            - containerPort: 11434
          volumeMounts:
            - name: ollama-storage
              mountPath: /root/.ollama
      volumes:
        - name: ollama-storage
          emptyDir: {}

---

# MLflow Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mlflow-deployement
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mlflow
  template:
    metadata:
      labels:
        app: mlflow
    spec:
      containers:
        - name: mlflow
          image: bouchras/mediassist-mlflow:latest
          ports:
            - containerPort: 5000
          command: ["mlflow", "server", "--host", "0.0.0.0", "--port", "5000"]
          volumeMounts:
            - name: mlflow-storage
              mountPath: /mlflow
      volumes:
        - name: mlflow-storage
          emptyDir: {}

---

# Prometheus Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
    scrape_configs:
      - job_name: 'api'
        scrape_interval: 5s
        static_configs:
          - targets: ['mediassist-backend-service:8000']
      - job_name: 'cadvisor'
        scrape_interval: 5s
        static_configs:
          - targets: ['cadvisor:8080']
    rule_files:
      - "/etc/prometheus/alert.rules.yml"
  alert.rules.yml: |
    groups:
    - name: mlops-alerts
      rules:
      - alert: HighRequestLatency
        expr: rag_processing_seconds_sum / rag_processing_seconds_count > 5
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "High RAG Request Latency"
          description: "Average RAG request processing time is > 5s"
      - alert: HighErrorRate
        expr: rate(rag_request_total{status="error"}[5m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "High RAG Error Rate"
          description: "RAG requests are failing"
      - alert: LowFaithfulness
        expr: rag_metric_faithfulness < 0.7
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Low RAG Faithfulness"
          description: "RAG Faithfulness score is below 0.7"

---

# Prometheus Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus-deployement
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
        - name: prometheus
          image: prom/prometheus
          ports:
            - containerPort: 9090
          volumeMounts:
            - name: config-volume
              mountPath: /etc/prometheus
      volumes:
        - name: config-volume
          configMap:
            name: prometheus-config

---

# Prometheus Service
apiVersion: v1
kind: Service
metadata:
  name: prometheus-svc
spec:
  selector:
    app: prometheus
  ports:
    - protocol: TCP
      port: 9090
      targetPort: 9090

---

# Grafana Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana-deployement
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
        - name: grafana
          image: grafana/grafana
          ports:
            - containerPort: 3000
          env:
            - name: GF_SECURITY_ADMIN_USER
              value: "admin"
            - name: GF_SECURITY_ADMIN_PASSWORD
              value: "admin"

---

# Grafana Service
apiVersion: v1
kind: Service
metadata:
  name: grafana-svc
spec:
  selector:
    app: grafana
  ports:
    - protocol: TCP
      port: 3000
      targetPort: 3000