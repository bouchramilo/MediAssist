apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  # Database Configuration
  POSTGRES_USER: "postgres"
  POSTGRES_PASSWORD: "password"
  POSTGRES_DB: "mediassist"
  POSTGRES_Server: "postgres-svc"
  POSTGRES_PORT: "5432"
  DATABASE_URL: "postgresql://postgres:password@postgres-svc:5432/mediassist"
  
  # External Services
  QDRANT_URL: "http://qdrant-svc:6333"
  OLLAMA_BASE_URL: "http://ollama-svc:11434"
  MLFLOW_TRACKING_URI: "http://mlflow-svc:5000"
  
  # Application Settings
  ENVIRONMENT: "production"
  SECRET_KEY: "your-secret-key-here-change-in-production"
  ALGORITHM: "HS256"

---

# Backend Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: project-deployement
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
        - name: backend
          image: bouchras/mediassist-backend:latest
          ports:
            - containerPort: 8000
          envFrom:
            - configMapRef:
                name: app-config

---

# Postgres Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-deployement
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:15-alpine
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_USER
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_DB
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: POSTGRES_DB
          volumeMounts:
            - name: postgres-storage
              mountPath: /var/lib/postgresql/data
      volumes:
        - name: postgres-storage
          emptyDir: {}

---

# Qdrant Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: qdrant-deployement
spec:
  replicas: 1
  selector:
    matchLabels:
      app: qdrant
  template:
    metadata:
      labels:
        app: qdrant
    spec:
      containers:
        - name: qdrant
          image: qdrant/qdrant:latest
          ports:
            - containerPort: 6333
          volumeMounts:
            - name: qdrant-storage
              mountPath: /qdrant/storage
      volumes:
        - name: qdrant-storage
          emptyDir: {}

---

# Ollama Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ollama-deployement
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ollama
  template:
    metadata:
      labels:
        app: ollama
    spec:
      containers:
        - name: ollama
          image: ollama/ollama:latest
          ports:
            - containerPort: 11434
          volumeMounts:
            - name: ollama-storage
              mountPath: /root/.ollama
      volumes:
        - name: ollama-storage
          emptyDir: {}

---

# MLflow Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mlflow-deployement
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mlflow
  template:
    metadata:
      labels:
        app: mlflow
    spec:
      containers:
        - name: mlflow
          image: bouchras/mediassist-mlflow:latest
          ports:
            - containerPort: 5000
          command: ["mlflow", "server", "--host", "0.0.0.0", "--port", "5000"]
          volumeMounts:
            - name: mlflow-storage
              mountPath: /mlflow
      volumes:
        - name: mlflow-storage
          emptyDir: {}